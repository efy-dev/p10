<!DOCTYPE html>
<html lang="en">
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0">
    <meta charset="UTF-8">
    <title>订单结算页</title>
    <link rel="stylesheet" href="guide/css/layouts.css?12">
</head>
<body>
<div class="header" dot-template="header"></div>
<!--//End--header-->

<article class="order">
    <div class="address-list" dot-template="purchase-address" style="width: 100%;">
        <!--<div class="item">-->
        <!--<p><strong>温群英</strong><span>15110008479</span></p>-->
        <!--<p>北京市朝阳区酒仙桥东路9号电子城科技园A2西侧6层</p>-->
        <!--<i class="arrow-right"></i>-->
        <!--</div>-->
    </div>
    <!--/End/-->
    <div class="order-base" dot-template="purchase-product">
        <!--<div class="text">-->
        <!--<img src="uploads/guide1.jpg" alt="">-->
        <!--<p class="title text_hidden">苏绣 — 清供小品</p>-->
        <!--<p class="subtitle text_hidden">店铺名称：姚惠芬苏绣艺术馆</p>-->
        <!--<p class="price text_hidden"><strong>¥19999</strong><span>X</span>1</p>-->
        <!--</div>-->
        <!--<div class="total">共计1件，商品金额<strong>¥19999</strong></div>-->
    </div>
    <!--/End/-->
    <div class="order-pay" dot-template="purchase-pay">
        <!--<div class="title">支付方式</div>-->
        <!--<ul class="pay">-->
        <!--<li class="active">-->
        <!--<input id="zhifubao" type="radio"><i class="icon zhifubao"></i>支付宝支付-->
        <!--</li>-->
        <!--<li>-->
        <!--<input id="wechat" type="radio"><i class="icon wechat"></i>微信支付-->
        <!--</li>-->
        <!--</ul>-->
    </div>
    <!--/End/-->
    <div class="order-invoice">
        <div class="title">开具发票</div>
        <ul class="invoice">
            <li><input type="text" placeholder="请填写发票类型" id="invoiceType" value="办公用品"></li>
            <li>
                <select name="" id="invoiceTitle">
                    <option value="公司">公司</option>
                    <option value="个人">个人</option>
                </select>
            </li>
            <li><input type="text" id="invoiceName" placeholder="请填写发票抬头"></li>
        </ul>
    </div>
    <!--/End/-->
    <div class="order-buy" dot-template="purchase-order">
        <!--<span>实付款： <strong>¥19999</strong></span>-->
        <!--<a class="link" href="">结算</a>-->
    </div>
    <!--/End/-->
</article>


<script type="text/x-dot-template" id="purchase-product">

    {{ var product = it[0]; }}

    <div class="text">
        <img src="{{=product.imageUrl}}" alt="">
        <p class="title text_hidden">{{=product.productModelName}}</p>
        <p class="subtitle text_hidden">店铺名称：{{=PageVariable.purchaseOrder.tenantName}}</p>
        <p class="price text_hidden"><strong>¥{{=product.price}}</strong><span>X</span>{{=product.amount}}</p>
    </div>
    <div class="total">共计{{=product.amount}}件，商品金额<strong>¥{{=(parseFloat(product.price) *
        parseInt(product.amount))}}</strong></div>

</script>

<script type="text/x-dot-template" id="purchase-order">

    <span>实付款： <strong>¥{{=it.total}}</strong></span>
    <a class="link" onclick="confirm()">结算</a>

</script>

<script type="text/x-dot-template" id="purchase-pay">

    <div class="title">支付方式</div>
    <ul class="pay">
        {{ if(!isWeiXin()){
        PageVariable.currentPaymentType="1";
        }}
        <li class="active">
            <input id="zhifubao" type="radio"><i class="icon zhifubao"></i>支付宝支付
        </li>
        {{ } else { PageVariable.currentPaymentType="3"; }}
        <li class="active">
            <input id="wechat" type="radio"><i class="icon wechat"></i>微信支付
        </li>
        {{ } }}
    </ul>

</script>


<script type="text/x-dot-template" id="purchase-address">
    <a onclick="addressList()">
        <div class="item">
            {{ if(it.id != null && typeof typeof it.id != "undefined"){ }}
            <p><strong>{{=it.consignee}}</strong><span>{{=it.phone}}</span></p>
            <p>{{=it.province+it.city+it.district+it.detail}}</p>
            <i class="arrow-right"></i>
            {{ }else{ }}
            <p></p>
            <p style="margin-top: 41px;">请选择收货地址</p>
            <i class="arrow-right"></i>
            {{ } }}
        </div>
    </a>
</script>


<script src="common/js/common.js"></script>
<script src="common/js/util.js"></script>
<script src="common/js/weixin.js"></script>
<script src="guide/js/controller.js"></script>
<script src="guide/js/model.js"></script>
<script src="http://res.wx.qq.com/open/js/jweixin-1.0.0.js"></script>
<!--//End-->
<script>
    $().ready(function () {
        initPage();
    });
    function initPage() {
        $("[dot-template=header]").html(renderHeader(PageVariable));
        //去掉搜索和下拉
        $("[dot-template=header]").find('.search,.user,.layer').remove();
        $('h1').html('订单结算');


        var requestParam = getRequestParameter();

        createNewOrder(requestParam.productList, requestParam.tenantId, function () {
            getPurchaseOrderById(PageVariable.purchaseOrderId, function () {
                renderTemplate(PageVariable.template.purchaseProduct, PageVariable.productList);
                renderTemplate(PageVariable.template.purchaseOrder, PageVariable.purchaseOrder);
                renderTemplate(PageVariable.template.purchasePay, {});
            })
        });


        getDefaultConsumerAddress(function () {
            renderTemplate(PageVariable.template.purchaseAddress, PageVariable.currentAddress)
        });

        selectPay();
    }


    //    1.解析请求参数；
    //    2.调用createNewOrder接口
    //    3.调用getPurchaseOrderById接口加载页面l


    //选择支付方式
    function selectPay() {
        var $orderPay = $('.order-pay');
        $orderPay.find('li').click(function () {
            $orderPay.find('input[type=radio]').prop("checked", false);
            $(this).addClass('active').siblings('li').removeClass('active');
            $(this).find('input[type=radio]').prop("checked", true);
        });
    }


    function confirm() {
//        1.获得支付方式
//        2.获得订单
//        3.获得发票信息
//        4.获得地址信息
//        4.1.参数校验
//        5.调用confirmOrderById方法
//        6.confirm成功之后跳转到支付处理接口
        var payment = PageVariable.currentPaymentType;
        var orderId = PageVariable.purchaseOrder.id;
        var invoiceName = $("#invoiceName").val();
        var invoiceType = $("#invoiceType").val();
        var invoiceTitle = $("#invoiceTitle").val();
        var consumerAddressId = PageVariable.currentAddress.id;
        if (typeof consumerAddressId == "undefined" || consumerAddressId == null || consumerAddressId == "") {
            modal.overAlert("请选择收货地址", "fail");
        } else {
            confirmOrderById(orderId, consumerAddressId, invoiceName, invoiceType, invoiceTitle, payment, function () {
                var redirectUrl = "http://localhost/order/pay/" + orderId;
                if (isWeiXin()) {
                    redirectUrl += "?isWeiXin=true";
                }
                window.location.href = redirectUrl;
            })
        }

    }


    function addressList() {

    }


</script>


</body>
</html>